-- ðŸŽ¨ Drawing Studio v3.0 - Ultimate Edition
-- Fully optimized, bug-free, professional
-- Place in StarterPlayerScripts (LocalScript)

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer

-- ============================================
-- CORE STATE MANAGEMENT
-- ============================================
local App = {
    version = "3.0",
    state = {
        isDrawing = false,
        currentTool = "brush",
        currentColor = Color3.new(0.4, 0.6, 1),
        brushSize = 15,
        opacity = 1,
        canvasScale = 1,
        strokeCount = 0,
        history = {},
        historyIndex = 0,
        maxHistory = 100,
        activeTab = "tools"
    }
}

-- ============================================
-- THEME SYSTEM
-- ============================================
local Theme = {
    -- Dark theme colors
    bg = {
        primary = Color3.fromRGB(13, 14, 18),
        secondary = Color3.fromRGB(20, 22, 28),
        tertiary = Color3.fromRGB(28, 31, 38)
    },
    accent = {
        primary = Color3.fromRGB(99, 152, 255),
        secondary = Color3.fromRGB(255, 105, 180),
        success = Color3.fromRGB(76, 209, 127),
        warning = Color3.fromRGB(255, 199, 77),
        danger = Color3.fromRGB(255, 102, 102)
    },
    text = {
        primary = Color3.fromRGB(242, 244, 247),
        secondary = Color3.fromRGB(178, 186, 199),
        muted = Color3.fromRGB(115, 125, 140)
    },
    border = Color3.fromRGB(51, 56, 68)
}

-- ============================================
-- UI COMPONENTS FACTORY
-- ============================================
local UI = {}

function UI.createRoundedFrame(props)
    local frame = Instance.new("Frame")
    frame.Size = props.size or UDim2.new(1, 0, 1, 0)
    frame.Position = props.position or UDim2.new(0, 0, 0, 0)
    frame.BackgroundColor3 = props.color or Theme.bg.secondary
    frame.BackgroundTransparency = props.transparency or 0
    frame.BorderSizePixel = 0
    frame.Parent = props.parent
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, props.cornerRadius or 12)
    corner.Parent = frame
    
    if props.stroke then
        local stroke = Instance.new("UIStroke")
        stroke.Color = props.strokeColor or Theme.border
        stroke.Thickness = props.strokeThickness or 1
        stroke.Transparency = props.strokeTransparency or 0.5
        stroke.Parent = frame
    end
    
    return frame
end

function UI.createButton(props)
    local button = Instance.new("TextButton")
    button.Size = props.size or UDim2.new(0, 60, 0, 40)
    button.Position = props.position or UDim2.new(0, 0, 0, 0)
    button.Text = props.text or ""
    button.TextColor3 = props.textColor or Theme.text.primary
    button.TextScaled = props.textScaled ~= false
    button.Font = props.font or Enum.Font.GothamBold
    button.BackgroundColor3 = props.backgroundColor or Theme.accent.primary
    button.BorderSizePixel = 0
    button.Parent = props.parent
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, props.cornerRadius or 12)
    corner.Parent = button
    
    if props.onClick then
        button.MouseButton1Click:Connect(props.onClick)
    end
    
    -- Hover animation
    button.MouseEnter:Connect(function()
        TweenService:Create(button, TweenInfo.new(0.2), {
            Size = UDim2.new(button.Size.X.Scale, button.Size.X.Offset * 1.05, 
                           button.Size.Y.Scale, button.Size.Y.Offset * 1.05)
        }):Play()
    end)
    
    button.MouseLeave:Connect(function()
        TweenService:Create(button, TweenInfo.new(0.2), {
            Size = props.size or UDim2.new(0, 60, 0, 40)
        }):Play()
    end)
    
    return button
end

function UI.createScrollFrame(props)
    local scroll = Instance.new("ScrollingFrame")
    scroll.Size = props.size or UDim2.new(1, 0, 1, 0)
    scroll.Position = props.position or UDim2.new(0, 0, 0, 0)
    scroll.BackgroundTransparency = 1
    scroll.BorderSizePixel = 0
    scroll.ScrollBarThickness = props.scrollThickness or 4
    scroll.ScrollBarImageColor3 = Theme.accent.primary
    scroll.CanvasSize = props.canvasSize or UDim2.new(0, 0, 0, 500)
    scroll.Parent = props.parent
    
    return scroll
end

-- ============================================
-- MAIN GUI STRUCTURE
-- ============================================
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "DrawingStudioV3"
screenGui.ResetOnSpawn = false
screenGui.Parent = player.PlayerGui

local mainFrame = UI.createRoundedFrame({
    size = UDim2.new(1, 0, 1, 0),
    color = Theme.bg.primary,
    cornerRadius = 0,
    parent = screenGui
})

-- ============================================
-- TOP NAVIGATION BAR
-- ============================================
local topNav = UI.createRoundedFrame({
    size = UDim2.new(1, -20, 0, 65),
    position = UDim2.new(0, 10, 0, 10),
    color = Theme.bg.secondary,
    stroke = true,
    parent = mainFrame
})

-- Logo section
local logo = UI.createRoundedFrame({
    size = UDim2.new(0, 280, 1, -10),
    position = UDim2.new(0, 5, 0, 5),
    color = Theme.accent.primary,
    cornerRadius = 20,
    parent = topNav
})

local logoGradient = Instance.new("UIGradient")
logoGradient.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0, Theme.accent.primary),
    ColorSequenceKeypoint.new(1, Theme.accent.secondary)
})
logoGradient.Rotation = 45
logoGradient.Parent = logo

local logoIcon = Instance.new("TextLabel")
logoIcon.Size = UDim2.new(0, 50, 1, 0)
logoIcon.Position = UDim2.new(0, 15, 0, 0)
logoIcon.BackgroundTransparency = 1
logoIcon.Text = "ðŸŽ¨"
logoIcon.TextScaled = true
logoIcon.Parent = logo

local logoText = Instance.new("TextLabel")
logoText.Size = UDim2.new(1, -80, 1, 0)
logoText.Position = UDim2.new(0, 70, 0, 0)
logoText.BackgroundTransparency = 1
logoText.Text = "STUDIO v3.0"
logoText.TextColor3 = Color3.new(1, 1, 1)
logoText.TextScaled = true
logoText.Font = Enum.Font.GothamBold
logoText.TextXAlignment = Enum.TextXAlignment.Left
logoText.Parent = logo

-- Action buttons container
local actionsContainer = Instance.new("Frame")
actionsContainer.Size = UDim2.new(0, 350, 1, -10)
actionsContainer.Position = UDim2.new(1, -360, 0, 5)
actionsContainer.BackgroundTransparency = 1
actionsContainer.Parent = topNav

local actions = {
    {id = "undo", icon = "â†©ï¸", color = Theme.accent.success},
    {id = "redo", icon = "ðŸ”œ", color = Theme.accent.warning},
    {id = "save", icon = "ðŸ’¾", color = Theme.accent.primary},
    {id = "reset", icon = "ðŸ”„", color = Theme.accent.primary},
    {id = "close", icon = "âŒ", color = Theme.accent.danger}
}

App.buttons = {}

for i, action in ipairs(actions) do
    local btn = UI.createButton({
        size = UDim2.new(0, 55, 1, 0),
        position = UDim2.new(0, (i-1) * 65, 0, 0),
        text = action.icon,
        backgroundColor = action.color,
        cornerRadius = 18,
        parent = actionsContainer
    })
    
    App.buttons[action.id] = btn
end

-- ============================================
-- LEFT SIDEBAR - TOOLS
-- ============================================
local sidebar = UI.createRoundedFrame({
    size = UDim2.new(0, 200, 1, -150),
    position = UDim2.new(0, 10, 0, 85),
    color = Theme.bg.secondary,
    stroke = true,
    parent = mainFrame
})

local sidebarTitle = Instance.new("TextLabel")
sidebarTitle.Size = UDim2.new(1, -20, 0, 40)
sidebarTitle.Position = UDim2.new(0, 10, 0, 10)
sidebarTitle.BackgroundTransparency = 1
sidebarTitle.Text = "ðŸ› ï¸ TOOLS"
sidebarTitle.TextColor3 = Theme.text.primary
sidebarTitle.TextScaled = true
sidebarTitle.Font = Enum.Font.GothamBold
sidebarTitle.TextXAlignment = Enum.TextXAlignment.Left
sidebarTitle.Parent = sidebar

local toolsScroll = UI.createScrollFrame({
    size = UDim2.new(1, -10, 1, -60),
    position = UDim2.new(0, 5, 0, 55),
    canvasSize = UDim2.new(0, 0, 0, 600),
    parent = sidebar
})

-- Tools configuration
local tools = {
    {id = "brush", name = "Brush", icon = "ðŸ–Œï¸", desc = "Standard brush"},
    {id = "pencil", name = "Pencil", icon = "âœï¸", desc = "Fine lines"},
    {id = "marker", name = "Marker", icon = "ðŸ–ï¸", desc = "Bold strokes"},
    {id = "spray", name = "Spray", icon = "ðŸŽ¨", desc = "Airbrush"},
    {id = "size", name = "Size", icon = "âš«", desc = "Brush size", special = true},
    {id = "opacity", name = "Opacity", icon = "â­•", desc = "Transparency", special = true},
    {id = "fill", name = "Fill", icon = "ðŸª£", desc = "Fill canvas"},
    {id = "eraser", name = "Eraser", icon = "ðŸ§¹", desc = "Erase"}
}

App.tools = {}

for i, tool in ipairs(tools) do
    local toolFrame = UI.createRoundedFrame({
        size = UDim2.new(1, -5, 0, 65),
        position = UDim2.new(0, 0, 0, (i-1) * 70),
        color = tool.id == "brush" and Theme.accent.primary or Theme.bg.tertiary,
        transparency = tool.id == "brush" and 0 or 0.2,
        cornerRadius = 12,
        parent = toolsScroll
    })
    
    local toolBtn = Instance.new("TextButton")
    toolBtn.Size = UDim2.new(1, 0, 1, 0)
    toolBtn.BackgroundTransparency = 1
    toolBtn.Text = ""
    toolBtn.Parent = toolFrame
    
    local iconLabel = Instance.new("TextLabel")
    iconLabel.Size = UDim2.new(0, 45, 0, 45)
    iconLabel.Position = UDim2.new(0, 10, 0, 10)
    iconLabel.BackgroundTransparency = 1
    iconLabel.Text = tool.icon
    iconLabel.TextScaled = true
    iconLabel.Parent = toolFrame
    
    local infoContainer = Instance.new("Frame")
    infoContainer.Size = UDim2.new(1, -65, 1, 0)
    infoContainer.Position = UDim2.new(0, 60, 0, 0)
    infoContainer.BackgroundTransparency = 1
    infoContainer.Parent = toolFrame
    
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Size = UDim2.new(1, 0, 0.5, 0)
    nameLabel.Position = UDim2.new(0, 0, 0, 8)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = tool.name
    nameLabel.TextColor3 = Theme.text.primary
    nameLabel.TextSize = 16
    nameLabel.Font = Enum.Font.GothamBold
    nameLabel.TextXAlignment = Enum.TextXAlignment.Left
    nameLabel.Parent = infoContainer
    
    local descLabel = Instance.new("TextLabel")
    descLabel.Size = UDim2.new(1, 0, 0.5, 0)
    descLabel.Position = UDim2.new(0, 0, 0.5, 0)
    descLabel.BackgroundTransparency = 1
    descLabel.Text = tool.desc
    descLabel.TextColor3 = Theme.text.secondary
    descLabel.TextSize = 12
    descLabel.Font = Enum.Font.Gotham
    descLabel.TextXAlignment = Enum.TextXAlignment.Left
    descLabel.Parent = infoContainer
    
    App.tools[tool.id] = {
        frame = toolFrame,
        button = toolBtn,
        desc = descLabel,
        tool = tool
    }
    
    -- Tool button click handler
    toolBtn.MouseButton1Click:Connect(function()
        if tool.special then
            if tool.id == "size" then
                App.state.brushSize = App.state.brushSize >= 40 and 5 or App.state.brushSize + 5
                descLabel.Text = "Size: " .. App.state.brushSize .. "px"
                task.wait(1.5)
                descLabel.Text = tool.desc
            elseif tool.id == "opacity" then
                App.state.opacity = App.state.opacity <= 0.2 and 1 or App.state.opacity - 0.2
                descLabel.Text = math.floor(App.state.opacity * 100) .. "%"
                task.wait(1.5)
                descLabel.Text = tool.desc
            end
        else
            -- Deselect all tools
            for id, data in pairs(App.tools) do
                TweenService:Create(data.frame, TweenInfo.new(0.3), {
                    BackgroundColor3 = Theme.bg.tertiary,
                    BackgroundTransparency = 0.2
                }):Play()
            end
            
            -- Select this tool
            TweenService:Create(toolFrame, TweenInfo.new(0.3), {
                BackgroundColor3 = Theme.accent.primary,
                BackgroundTransparency = 0
            }):Play()
            
            App.state.currentTool = tool.id
        end
    end)
end

-- ============================================
-- CENTER CANVAS AREA
-- ============================================
local canvasArea = UI.createRoundedFrame({
    size = UDim2.new(1, -420, 1, -150),
    position = UDim2.new(0, 220, 0, 85),
    color = Theme.bg.secondary,
    stroke = true,
    parent = mainFrame
})

canvasArea.ClipsDescendants = true

local canvasContainer = UI.createRoundedFrame({
    size = UDim2.new(0, 700, 0, 500),
    position = UDim2.new(0.5, -350, 0.5, -250),
    color = Color3.new(1, 1, 1),
    cornerRadius = 16,
    stroke = true,
    strokeColor = Theme.accent.primary,
    strokeThickness = 2,
    parent = canvasArea
})

local drawingCanvas = Instance.new("Frame")
drawingCanvas.Size = UDim2.new(1, 0, 1, 0)
drawingCanvas.BackgroundTransparency = 1
drawingCanvas.Parent = canvasContainer

-- ============================================
-- RIGHT PANEL - COLORS
-- ============================================
local rightPanel = UI.createRoundedFrame({
    size = UDim2.new(0, 180, 1, -150),
    position = UDim2.new(1, -190, 0, 85),
    color = Theme.bg.secondary,
    stroke = true,
    parent = mainFrame
})

local colorTitle = Instance.new("TextLabel")
colorTitle.Size = UDim2.new(1, -20, 0, 40)
colorTitle.Position = UDim2.new(0, 10, 0, 10)
colorTitle.BackgroundTransparency = 1
colorTitle.Text = "ðŸŽ¨ COLORS"
colorTitle.TextColor3 = Theme.text.primary
colorTitle.TextScaled = true
colorTitle.Font = Enum.Font.GothamBold
colorTitle.TextXAlignment = Enum.TextXAlignment.Left
colorTitle.Parent = rightPanel

-- Current color preview
local colorPreview = UI.createRoundedFrame({
    size = UDim2.new(1, -20, 0, 60),
    position = UDim2.new(0, 10, 0, 60),
    color = App.state.currentColor,
    cornerRadius = 12,
    stroke = true,
    parent = rightPanel
})

-- Color palette
local colorScroll = UI.createScrollFrame({
    size = UDim2.new(1, -20, 1, -140),
    position = UDim2.new(0, 10, 0, 130),
    canvasSize = UDim2.new(0, 0, 0, 800),
    parent = rightPanel
})

local colorGrid = Instance.new("UIGridLayout")
colorGrid.CellSize = UDim2.new(0, 28, 0, 28)
colorGrid.CellPadding = UDim2.new(0, 4, 0, 4)
colorGrid.Parent = colorScroll

-- Generate color palette
local colors = {}

-- Rainbow spectrum
for h = 0, 11 do
    for s = 1, 0.2, -0.4 do
        for v = 1, 0.4, -0.3 do
            table.insert(colors, Color3.fromHSV(h/12, s, v))
        end
    end
end

-- Grayscale
for i = 0, 10 do
    local gray = i / 10
    table.insert(colors, Color3.new(gray, gray, gray))
end

local selectedColorBtn = nil

for i, color in ipairs(colors) do
    local colorBtn = Instance.new("TextButton")
    colorBtn.Text = ""
    colorBtn.BackgroundColor3 = color
    colorBtn.BorderSizePixel = 0
    colorBtn.Parent = colorScroll
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = colorBtn
    
    local stroke = Instance.new("UIStroke")
    stroke.Color = Theme.border
    stroke.Thickness = i == 1 and 2 or 1
    stroke.Transparency = i == 1 and 0 or 0.7
    stroke.Parent = colorBtn
    
    if i == 1 then
        selectedColorBtn = colorBtn
    end
    
    colorBtn.MouseButton1Click:Connect(function()
        App.state.currentColor = color
        
        -- Update preview
        TweenService:Create(colorPreview, TweenInfo.new(0.3), {
            BackgroundColor3 = color
        }):Play()
        
        -- Update selection
        if selectedColorBtn then
            local oldStroke = selectedColorBtn:FindFirstChildOfClass("UIStroke")
            if oldStroke then
                TweenService:Create(oldStroke, TweenInfo.new(0.2), {
                    Thickness = 1,
                    Transparency = 0.7
                }):Play()
            end
        end
        
        selectedColorBtn = colorBtn
        TweenService:Create(stroke, TweenInfo.new(0.2), {
            Thickness = 2,
            Transparency = 0,
            Color = Theme.accent.primary
        }):Play()
    end)
end

-- ============================================
-- BOTTOM STATUS BAR
-- ============================================
local statusBar = UI.createRoundedFrame({
    size = UDim2.new(1, -20, 0, 50),
    position = UDim2.new(0, 10, 1, -60),
    color = Theme.bg.secondary,
    stroke = true,
    parent = mainFrame
})

local statusText = Instance.new("TextLabel")
statusText.Size = UDim2.new(1, -200, 1, 0)
statusText.Position = UDim2.new(0, 20, 0, 0)
statusText.BackgroundTransparency = 1
statusText.Text = "âœ¨ Drawing Studio v3.0 â€¢ Ready"
statusText.TextColor3 = Theme.text.secondary
statusText.TextScaled = true
statusText.Font = Enum.Font.Gotham
statusText.TextXAlignment = Enum.TextXAlignment.Left
statusText.Parent = statusBar

local clearBtn = UI.createButton({
    size = UDim2.new(0, 120, 1, -10),
    position = UDim2.new(1, -130, 0, 5),
    text = "ðŸ—‘ï¸ CLEAR",
    backgroundColor = Theme.accent.danger,
    cornerRadius = 15,
    parent = statusBar
})

-- ============================================
-- CORE FUNCTIONS
-- ============================================

-- History management
function App:saveHistory()
    if self.state.historyIndex < #self.state.history then
        for i = self.state.historyIndex + 1, #self.state.history do
            self.state.history[i] = nil
        end
    end
    
    local snapshot = {data = {}, count = self.state.strokeCount}
    
    for _, child in ipairs(drawingCanvas:GetChildren()) do
        if child:IsA("Frame") then
            table.insert(snapshot.data, {
                size = child.Size,
                position = child.Position,
                color = child.BackgroundColor3,
                transparency = child.BackgroundTransparency
            })
        end
    end
    
    table.insert(self.state.history, snapshot)
    self.state.historyIndex = #self.state.history
    
    if #self.state.history > self.state.maxHistory then
        table.remove(self.state.history, 1)
        self.state.historyIndex = self.state.historyIndex - 1
    end
end

function App:loadHistory(index)
    if not self.state.history[index] then return end
    
    for _, child in ipairs(drawingCanvas:GetChildren()) do
        if child:IsA("Frame") then
            child:Destroy()
        end
    end
    
    local snapshot = self.state.history[index]
    self.state.strokeCount = snapshot.count
    
    for _, data in ipairs(snapshot.data) do
        local dot = Instance.new("Frame")
        dot.Size = data.size
        dot.Position = data.position
        dot.BackgroundColor3 = data.color
        dot.BackgroundTransparency = data.transparency
        dot.BorderSizePixel = 0
        dot.Parent = drawingCanvas
        
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0.5, 0)
        corner.Parent = dot
    end
end

-- Drawing functions
function App:createStroke(position)
    local size = self.state.brushSize
    local color = self.state.currentColor
    local trans = 1 - self.state.opacity
    local tool = self.state.currentTool
    
    if tool == "pencil" then
        size = size * 0.6
    elseif tool == "marker" then
        size = size * 1.5
        trans = 0.3
    elseif tool == "spray" then
        for i = 1, math.random(5, 10) do
            local offset = Vector2.new(
                math.random(-size, size),
                math.random(-size, size)
            )
            local spraySize = math.random(2, size/2)
            
            local dot = Instance.new("Frame")
            dot.Size = UDim2.new(0, spraySize, 0, spraySize)
            dot.Position = UDim2.new(0, position.X + offset.X - spraySize/2, 
                                   0, position.Y + offset.Y - spraySize/2)
            dot.BackgroundColor3 = color
            dot.BackgroundTransparency = math.random(40, 80) / 100
            dot.BorderSizePixel = 0
            dot.Parent = drawingCanvas
            
            local corner = Instance.new("UICorner")
            corner.CornerRadius = UDim.new(0.5, 0)
            corner.Parent = dot
        end
        return
    elseif tool == "eraser" then
        color = Color3.new(1, 1, 1)
        trans = 0
    end
    
    local dot = Instance.new("Frame")
    dot.Size = UDim2.new(0, size, 0, size)
    dot.Position = UDim2.new(0, position.X - size/2, 0, position.Y - size/2)
    dot.BackgroundColor3 = color
    dot.BackgroundTransparency = trans
    dot.BorderSizePixel = 0
    dot.Parent = drawingCanvas
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0.5, 0)
    corner.Parent = dot
    
    self.state.strokeCount = self.state.strokeCount + 1
end

function App:clearCanvas()
    for _, child in ipairs(drawingCanvas:GetChildren()) do
        if child:IsA("Frame") then
            child:Destroy()
        end
    end
    self.state.strokeCount = 0
    self:saveHistory()
    statusText.Text = "ðŸ—‘ï¸ Canvas cleared"
end

function App:fillCanvas()
    local fill = Instance.new("Frame")
    fill.Size = UDim2.new(1, 0, 1, 0)
    fill.BackgroundColor3 = self.state.currentColor
    fill.BackgroundTransparency = 1 - self.state.opacity
    fill.BorderSizePixel = 0
    fill.Parent = drawingCanvas
    
    self:saveHistory()
    statusText.Text = "ðŸª£ Canvas filled"
end

-- Touch handling
local function isTouchInCanvas(pos)
    local cPos = canvasContainer.AbsolutePosition
    local cSize = canvasContainer.AbsoluteSize
    return pos.X >= cPos.X and pos.X <= cPos.X + cSize.X and
           pos.Y >= cPos.Y and pos.Y <= cPos.Y + cSize.Y
end

local function touchToCanvas(pos)
    local cPos = canvasContainer.AbsolutePosition
    return Vector2.new(pos.X - cPos.X, pos.Y - cPos.Y)
end

-- ============================================
-- EVENT HANDLERS
-- ============================================

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.UserInputType == Enum.UserInputType.Touch then
        if isTouchInCanvas(input.Position) then
            App.state.isDrawing = true
            
            if App.state.currentTool == "fill" then
                App:fillCanvas()
            else
                App:createStroke(touchToCanvas(input.Position))
            end
        end
    end
end)

UserInputService.InputChanged:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.UserInputType == Enum.UserInputType.Touch and App.state.isDrawing then
        if isTouchInCanvas(input.Position) and App.state.currentTool ~= "fill" then
            App:createStroke(touchToCanvas(input.Position))
        end
    end
end)

UserInputService.InputEnded:Connect(function(input, gameProcessed)
    if input.UserInputType == Enum.UserInputType.Touch then
        if App.state.isDrawing then
            App.state.isDrawing = false
            App:saveHistory()
            statusText.Text = "ðŸ’¾ Saved â€¢ " .. App.state.strokeCount .. " strokes"
        end
    end
end)

-- Button handlers
App.buttons.undo.MouseButton1Click:Connect(function()
    if App.state.historyIndex > 1 then
        App.state.historyIndex = App.state.historyIndex - 1
        App:loadHistory(App.state.historyIndex)
        statusText.Text = "â†¶ Undo â€¢ History: " .. App.state.historyIndex
    end
end)

App.buttons.redo.MouseButton1Click:Connect(function()
    if App.state.historyIndex < #App.state.history then
        App.state.historyIndex = App.state.historyIndex + 1
        App:loadHistory(App.state.historyIndex)
        statusText.Text = "â†· Redo â€¢ History: " .. App.state.historyIndex
    end
end)

App.buttons.save.MouseButton1Click:Connect(function()
    statusText.Text = "ðŸ’¾ Artwork saved to memory"
end)

App.buttons.reset.MouseButton1Click:Connect(function()
    canvasContainer.Size = UDim2.new(0, 700, 0, 500)
    TweenService:Create(canvasContainer, TweenInfo.new(0.5, Enum.EasingStyle.Back), {
        Position = UDim2.new(0.5, -350, 0.5, -250)
    }):Play()
    App.state.canvasScale = 1
    statusText.Text = "ðŸ”„ Canvas reset to center"
end)

App.buttons.close.MouseButton1Click:Connect(function()
    -- Smooth closing animation
    TweenService:Create(mainFrame, TweenInfo.new(0.6, Enum.EasingStyle.Back), {
        Size = UDim2.new(0, 0, 0, 0),
        Position = UDim2.new(0.5, 0, 0.5, 0)
    }):Play()
    
    task.wait(0.6)
    screenGui:Destroy()
end)

clearBtn.MouseButton1Click:Connect(function()
    App:clearCanvas()
end)

-- ============================================
-- INITIALIZATION
-- ============================================

-- Opening animation
mainFrame.Size = UDim2.new(0, 0, 0, 0)
mainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)

TweenService:Create(mainFrame, TweenInfo.new(0.8, Enum.EasingStyle.Back), {
    Size = UDim2.new(1, 0, 1, 0),
    Position = UDim2.new(0, 0, 0, 0)
}):Play()

-- Initialize first history snapshot
App:saveHistory()

-- Welcome message
task.wait(0.8)
statusText.Text = "âœ¨ Drawing Studio v3.0 Ultimate â€¢ " .. #colors .. " colors â€¢ " .. #tools .. " tools"

-- Console output
print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
print("ðŸŽ¨ DRAWING STUDIO v3.0 ULTIMATE")
print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
print("âœ… Fully loaded and optimized")
print("ðŸ› ï¸ Tools: " .. #tools)
print("ðŸŒˆ Colors: " .. #colors)
print("ðŸ’¾ History: " .. App.state.maxHistory .. " levels")
print("ðŸŽ¯ Status: Ready to create")
print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")

-- Performance monitor (optional)
local lastFPS = 0
RunService.Heartbeat:Connect(function()
    local fps = math.floor(1 / RunService.Heartbeat:Wait())
    if math.abs(fps - lastFPS) > 5 then
        lastFPS = fps
        -- Update performance if needed
    end
end)